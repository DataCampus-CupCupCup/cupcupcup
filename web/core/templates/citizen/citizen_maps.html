{% extends 'layouts/base.html' %}

{% block title %} Maps {% endblock title %}
{% block nav %}내 지역구 보기{% endblock nav %}
{% block content %}

    <!-- Header -->
    <div class="header bg-gradient-primary pb-8 pt-6 md-8">
      <div class="container-fluid">
        <div class="row row-cols-sm-2">
            <div class="col-xl-6 input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text" id="addon-wrapping"><i class="fas fa-search"></i></span>
              </div>
              <input type="text" class="form-control" placeholder="지역구명을 적어주세요. 예) 부산진구" aria-label="Recipient's username" aria-describedby="search" aria-describedby="addon-wrapping">
              <div class="input-group-append">
                <button class="btn btn-light" type="button" id="search">내 지역구 검색</button>
              </div>
            </div>
            <div class="ml-2 row pt-1">
              <div class="mr-2 mb-2">
                <button id='preCupOnly' class="btn btn-primary">현재 수거함만 보기</button>
                <button id='cellOnly' class="btn btn-slack">예상 수거함만 보기</button>
              </div>
              <div class="col pl-0 pr-4">
                <button id='both' class="btn btn-warning btn-block ">둘다 보기</button>
              </div>
            </div>
          <div class="col-12">
            <div class="card shadow border-0 mt-3">
              <div id="map" class="map-canvas" style="height: 600px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid mt--7">
      <div class="header-body">
        <!-- Card stats -->
        <div class="row">
          <div class="col-lg-6">
            <div class="card card-stats mb-4 mb-xl-0">
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">우리구 수거함 갯수</h5>
                    <span class="h2 font-weight-bold mb-0">{{cnt1}}</span> 개
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-danger text-white rounded-circle shadow">
                      <i class="fas fa-trash-alt"></i>
                    </div>
                  </div>
                </div>
                <p class="mt-3 mb-0 text-muted text-sm">
                  <span class="text-danger mr-2"><i class="fas fa-arrow-down"></i> 3개</span>
                  <span class="text-nowrap">다른 구 평균 보다</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card card-stats mb-4 mb-xl-0">
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <h5 class="card-title text-uppercase text-muted mb-0">설치 필요 지역</h5>
                    <span class="h2 font-weight-bold mb-0">{{cnt2}}</span> 개
                  </div>
                  <div class="col-auto">
                    <div class="icon icon-shape bg-success text-white rounded-circle shadow">
                      <i class="fas fa-recycle"></i>
                    </div>
                  </div>
                </div>
                <p class="mt-3 mb-0 text-muted text-sm">
                  <span class="text-danger mr-2"><i class="fas fa-arrow-up"></i> 40 개 지역</span>
                  <span class="text-nowrap">다른 구 평균 보다</span>
                </p>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
    
    <div class="container-fluid mt-4">
      <div id="detail" class="row collapse">
        <div class="col-12">
          <div class="card bg-secondary shadow">
            <div class="card-header bg-white border-0">
              <div class="row align-items-center">
                <div class="col-7 col-lg-8">
                  <h3 class="mb-0">장소 상세 정보</h3>
                </div>
                <div class="col-4 text-right pl-0">
                  <a class="btn btn-primary toMap">지도로 가기</a>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="card shadow border-0 mt-3">
                <div id="smallmap" class="map-canvas" style="height: 350px;"></div>
              </div>
              
                <div class="card-body">
                  <div class="row">
                    <div class="col-auto">
                      <div class="icon icon-shape text-primary rounded shadow">
                        <i class="fas fa-map-marker-alt"></i>
                      </div>
                    </div>
                    <div class="col align-self-center">
                      <span class="h4 font-weight-bold">주소 : <span id='address'></span></span>
                    </div>
                  </div>
                </div>
              
              <div class="row">
                <div class="col-lg-6">
                  <div class="card card-stats mb-4 mb-xl-0">
                    <div class="card-body">
                      <div class="row">
                        <div class="col-auto">
                          <div class="icon icon-shape bg-success text-white rounded shadow">
                            <i class="fas fa-laugh-squint"></i>
                          </div>
                        </div>
                        <div class="col align-self-center">
                          <span class="h5 font-weight-bold"><span id='good'>50</span> 명의 사람들이 이 장소를 좋아합니다!</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="card card-stats mb-4 mb-xl-0">
                    <div class="card-body">
                      <div class="row">
                        <div class="col-auto">
                          <div class="icon icon-shape bg-warning text-white rounded shadow">
                            <i class="far fa-grin-beam-sweat"></i>
                          </div>
                        </div>
                        <div class="col align-self-center">
                          <span class="h5 font-weight-bold"><span id='bad'>0</span> 명의 싫어하는 사람들..</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
                <hr class="my-4" />
                <!-- Address -->
                <h6 class="heading text-muted mb-4">이 위치가 마음에 드시나요?</h6>
                <div class="row row-col-3">
                  <div class="col">
                    <button type="button" id="like" class="btn btn-warning btn-block"><i class="far fa-thumbs-up"></i> 좋아요</button>
                  </div>
                  <div class="col">
                    <button type="button" id="dislike" class="btn btn-twitter btn-block"><i class="far fa-thumbs-down"></i> 싫어요</button>
                  </div>
                  <div class="col mt-3 mt-lg-0">
                    <a href="/opinion"><button type="button" id="opinion" class="btn btn-neutral btn-block"><i class="fas fa-pencil-alt"></i> 자세한 의견 작성하러 가기</button></a>
                  </div>
                </div>
                
              
            </div>
          </div>
        </div>
      </div>
      {% include "includes/footer.html" %}

    </div>

{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}
<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
<script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDMkWvo1fWXALAlUAbyXEB_lSquL2ibfx0&callback=initMap&region=kr"></script>
<script type="text/javascript">
  var presentCups = JSON.parse('{{presentCups|safe}}');
  var predictCups = JSON.parse('{{predictCups|safe}}');

  // console.log(presentCups);
  // console.log(predictCups);

  let map;
  let smallmap;
  let small_map_marker;
  let cells;
  let polygons;
  let polygon_centers;
  let pre_cups;



  function initMap(){
    const center = { lat: presentCups[9]['lat'] ,lng: presentCups[9]['long'] };
    map = new google.maps.Map( document.getElementById('map'), { zoom: 14, center: center });
    smallmap = new google.maps.Map( document.getElementById('smallmap'), { zoom: 17, center: center });

    cells = makeCells();
    polygons = makePolygons(cells);
    polygon_centers = makePolygonCenters(cells, map);
    pre_cups = makePreCups(map);
    setMapOnAll(pre_cups, map);
    setMapOnAll(polygon_centers, map);
    setMapOnAll(polygons, map);
  }

  function makeCells(){
    var cells = []
    for(var i in predictCups){
      coors = predictCups[i]
      const cellCoords = [
      { lat: coors['lat1'], lng: coors['long1'] },
      { lat: coors['lat2'], lng: coors['long2'] },
      { lat: coors['lat4'], lng: coors['long4'] },
      { lat: coors['lat3'], lng: coors['long3'] }
      ];
      cells.push(cellCoords);
    }
    return cells;
  }
  
  function makePolygons(cells){
    var polygons = [];
    for(var i in cells){
      var ploygon = new google.maps.Polygon({
        paths: cells[i],
        strokeColor: "#ffe54a",
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: "#ffe54a",
        fillOpacity: 0.35
      });
      polygons.push(ploygon);
    }
    return polygons;
  }

  function makePolygonCenters(cells, map){
    var polygon_centers = [];
    const shape = {
    coords: [1, 1, 1, 20, 18, 20, 18, 1],
    type: "poly"
    };

    for(var i in cells){
      var lat =0.0, long =0.0;
      for (var j in cells[i]){
        lat += parseFloat(cells[i][j]['lat']);
        long += parseFloat(cells[i][j]['lng']);
      }
      lat = lat/cells[i].length;
      long = long/cells[i].length;
      // console.log(lat, long);
      var center = new google.maps.Marker({
        position: { lat: lat, lng: long },
        map,
        icon: '/static/assets/img/map/green_cup_resize2.png',
        shape: shape,
        title: i,
        zIndex: parseInt(i),
        label: {text : 'predictCups', fontSize : '0px'}
      });
      center.addListener("click", moveToDiv);
      polygon_centers.push(center);
    }
    return polygon_centers;
  }
  
  function makePreCups(map) {
    var pre_cups=[]
    const shape = {
    coords: [1, 1, 1, 20, 18, 20, 18, 1],
    type: "poly"
    };

    for (var i in presentCups) {
      const precup = presentCups[i];
      var pre_cup = new google.maps.Marker({
        position: { lat: precup['lat'], lng: precup['long'] },
        map,
        icon: '/static/assets/img/map/orange_cup_resize2.png',
        title: presentCups[i]['id'],
        zIndex: parseInt(i),
        label: {text : 'presentCups', fontSize : '0px'}
      });
      pre_cup.addListener("click", moveToDiv);
      pre_cups.push(pre_cup);
    }
    return pre_cups;
  }

  function setMapOnAll(markers, map){
    for(var i in markers){
      markers[i].setMap(map);
    }
  }

  // Removes the markers from the map, but keeps them in the array.
  function clearMarkers(markers) {
    setMapOnAll(markers,null);
  }

  function moveToDiv(){
      label = this.getLabel()['text'];
      index = this.getZIndex();

      let cup, marker_image, address, like, dislike, lat, long;
      if(label == 'predictCups'){
        cup = predictCups[index];
        let small_map_polygon = new google.maps.Polygon({
        paths: [
        { lat: cup['lat1'], lng: cup['long1'] },
        { lat: cup['lat2'], lng: cup['long2'] },
        { lat: cup['lat4'], lng: cup['long4'] },
        { lat: cup['lat3'], lng: cup['long3'] }
        ],
        strokeColor: "#ffe54a",
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: "#ffe54a",
        fillOpacity: 0.35
        });
        small_map_polygon.setMap(smallmap);

        lat = cup['lat1']+cup['lat2']+cup['lat3']+cup['lat4']/4.0;
        long = cup['long1']+cup['long2']+cup['long3']+cup['long4']/4.0;
        marker_image = '/static/assets/img/map/green_cup_resize2.png';
      }else{
        cup = presentCups[index];
        lat = cup['lat'];
        long = cup['long'];
        marker_image = '/static/assets/img/map/orange_cup_resize2.png';
      }
      address = cup['address'];
      like = cup['like'];
      dislike = cup['dislike'];
    
      $("#address").text(address);   
      $("#good").text(like);   
      $("#bad").text(dislike);

      let marker = { lat: lat, lng: long };
      smallmap.setCenter(marker);

      small_map_marker = new google.maps.Marker({
        position: { lat: lat, lng: long },
        smallmap,
        icon: marker_image,
        title: 'cup',
        zIndex: index,
        label: {text : label, fontSize : '0px'}
      });
      small_map_marker.setMap(smallmap);
      $('#detail').toggleClass("collapse");
      $('#detail')[0].scrollIntoView({behavior: "smooth"});
  }

  $( document ).ready( function() {
    $('#cellOnly').click( function() {
      setMapOnAll(polygon_centers, map);
      setMapOnAll(polygons, map);
      clearMarkers(pre_cups);
    });

    $('#preCupOnly').click( function() {
      setMapOnAll(pre_cups, map);
      clearMarkers(polygon_centers);
      clearMarkers(polygons);
    });

    $('#both').click( function() {
      clearMarkers();
      setMapOnAll(pre_cups, map);
      setMapOnAll(polygon_centers, map);
      setMapOnAll(polygons, map);
    });
    
    $('.toMap').click( function() {
      $('#detail').toggleClass("collapse");
      $('#map')[0].scrollIntoView({behavior: "smooth"});
    });
  });
</script>

{% endblock javascripts %}
